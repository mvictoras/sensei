<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>sensei</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://kitware.github.io/sensei/develop/python-analysis.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://kitware.github.io/sensei/develop/python-analysis.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  <link rel="stylesheet" href="/css/navy.css">
  <!-- endbuild -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="sensei">
  <!-- Open Graph -->
  <meta name="description" content="PythonAnalysis adaptorThe python analysis adaptor enables the use of a Python scripts as an analysis back end. It accomplishes this by embedding a Python interpreter and includes a minimal set of the">
<meta property="og:type" content="website">
<meta property="og:title" content="sensei">
<meta property="og:url" content="https://kitware.github.io/sensei/develop/python-analysis.html">
<meta property="og:site_name" content="sensei">
<meta property="og:description" content="PythonAnalysis adaptorThe python analysis adaptor enables the use of a Python scripts as an analysis back end. It accomplishes this by embedding a Python interpreter and includes a minimal set of the">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-11-11T16:04:39.832Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sensei">
<meta name="twitter:description" content="PythonAnalysis adaptorThe python analysis adaptor enables the use of a Python scripts as an analysis back end. It accomplishes this by embedding a Python interpreter and includes a minimal set of the">
  <!-- Google Analytics -->
  
</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/" id="logo">sensei</a>
    </h1>
    <nav id="main-nav">
      <a href="/learn-more/" class="main-nav-link">Learn more</a><a href="/develop/" class="main-nav-link">Develop</a><a href="/news/" class="main-nav-link">News</a>
      <a href="https://github.com/kitware/sensei" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name"></h1>
              </header>
              <div class="article-content" itemprop="articleBody">
                <h1 id="PythonAnalysis-adaptor" class="article-heading"><a href="#PythonAnalysis-adaptor" class="headerlink" title="PythonAnalysis adaptor"></a>PythonAnalysis adaptor<a class="article-anchor" href="#PythonAnalysis-adaptor" aria-hidden="true"></a></h1><p>The python analysis adaptor enables the use of a Python scripts as an analysis
back end. It accomplishes this by embedding a Python interpreter and includes a
minimal set of the sensei python bindings. To author a new python analysis one
must provide a python script that implements three functions: <code>Inititalize</code>,
<code>Execute</code> and <code>Finalize</code>. These functions implement the <code>sensei::AnalysisAdaptor</code>
API. The <code>Execute</code> function is required while <code>Initialize</code> and <code>Finalize</code>
functions are optional. The <code>Execute</code> function is passed a <code>sensei::DataAdaptor</code>
instance from which one has access to simulation data structures. If an error
occurs during processing one should <code>raise</code> an exception. If the analysis
required MPI communication, one must make use of the adaptor’s MPI communicator
which is stored in the global variable <code>comm</code>.  Additionally one can provide a
secondary script that is executed prior to the API functions. This script can
set global variables that control runtime behavior.</p>
<p>End users will make use of the <code>sensei::ConfigurableAnalysis</code> and point to the
python analysis script. The script can be loaded in one of two ways: via
python’s import machinery or via a customized mechanism that reads the file on
MPI rank 0 and broadcasts it to the other ranks. The latter is the recommended
approach.</p>
<h2 id="ConfigurableAnalysis-XML" class="article-heading"><a href="#ConfigurableAnalysis-XML" class="headerlink" title="ConfigurableAnalysis XML"></a>ConfigurableAnalysis XML<a class="article-anchor" href="#ConfigurableAnalysis-XML" aria-hidden="true"></a></h2><p>The <code>&lt;analysis&gt;</code> element is used to create and configure the <code>PythonAnalysis</code> instance.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>type</th>
<th>allowable value(s)</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>attribute</td>
<td>“python”</td>
<td>Creates a <code>PythonAnalysis</code> instance</td>
</tr>
<tr>
<td><code>script_module</code></td>
<td>attribute</td>
<td>a module name</td>
<td>Names a module that is in the PYTHONPATH. The module should define the 3 analysis adaptor API functions: <code>Initialize</code>, <code>Execute</code>, and <code>Finalize</code>. It is imported during initialization using python’s import machinery. *</td>
</tr>
<tr>
<td><code>script_file</code></td>
<td>attribute</td>
<td>a file path</td>
<td>A path to a python script to be loaded and broadcast by rank 0. The script should define the 3 analysis adaptor API functions: <code>Initialize</code>, <code>Execute</code>, and <code>Finalize</code>. *</td>
</tr>
<tr>
<td><code>enabled</code></td>
<td>attribute</td>
<td>0,1</td>
<td>When 0 the analysis is skipped</td>
</tr>
<tr>
<td><code>initialize_source</code></td>
<td>child element</td>
<td>python source code</td>
<td>A snippet of source code that can be used to control run time behavior. The source code must be properly formatted and indented. The contents of the element are taken verbatim including newline tabs and spaces.</td>
</tr>
</tbody>
</table>
<p>* – use one of <code>script_file</code> or <code>script_module</code>. Prefer <code>script_file</code>.</p>
<p>See the <a href="#histogramxml">example</a> below.</p>
<h2 id="Code-Template" class="article-heading"><a href="#Code-Template" class="headerlink" title="Code Template"></a>Code Template<a class="article-anchor" href="#Code-Template" aria-hidden="true"></a></h2><p>The following template provides stubs that one can fill in to write a new python
analysis.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># YOUR IMPORTS HERE</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Initialize</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="string">""" Initialization code """</span></span><br><span class="line">  <span class="comment"># YOUR CODE HERE</span></span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Execute</span><span class="params">(dataAdaptor)</span>:</span></span><br><span class="line">  <span class="string">""" Use sensei::DataAdaptor instance passed in</span></span><br><span class="line"><span class="string">      dataAdaptor to access and process simulation data """</span></span><br><span class="line">  <span class="comment"># YOUR CODE HERE</span></span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Finalize</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="string">""" Finalization code """</span></span><br><span class="line">  <span class="comment"># YOUR CODE HERE</span></span><br><span class="line">  <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<h2 id="Example" class="article-heading"><a href="#Example" class="headerlink" title="Example"></a>Example<a class="article-anchor" href="#Example" aria-hidden="true"></a></h2><p>The following example computes a histogram in parallel. It is included in the source code at <code>sensei/Histogram.py</code>.</p>
<h3 id="Histogram-py" class="article-heading"><a href="#Histogram-py" class="headerlink" title="Histogram.py"></a>Histogram.py<a class="article-anchor" href="#Histogram-py" aria-hidden="true"></a></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> vtk.util.numpy_support <span class="keyword">as</span> vtknp</span><br><span class="line"><span class="keyword">from</span> vtk <span class="keyword">import</span> vtkDataObject, vtkCompositeDataSet, vtkMultiBlockDataSet</span><br><span class="line"></span><br><span class="line"><span class="comment"># default values of control parameters</span></span><br><span class="line">numBins = <span class="number">10</span></span><br><span class="line">meshName = <span class="string">''</span></span><br><span class="line">arrayName = <span class="string">''</span></span><br><span class="line">arrayCen = vtkDataObject.POINT</span><br><span class="line">outFile = <span class="string">'hist'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Initialize</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># check for valid control parameters</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> meshName:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'meshName was not set'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> arrayName:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'arrayName was not set'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Execute</span><span class="params">(adaptor)</span>:</span></span><br><span class="line">    r = comm.Get_rank()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the mesh and array we need</span></span><br><span class="line">    mesh = adaptor.GetMesh(meshName, <span class="keyword">True</span>)</span><br><span class="line">    adaptor.AddArray(mesh, meshName, arrayCen, arrayName)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># force composite data to simplify computations</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(mesh, vtkCompositeDataSet):</span><br><span class="line">        s = comm.Get_size()</span><br><span class="line">        mb = vtkMultiBlockDataSet()</span><br><span class="line">        mb.SetNumberOfBlocks(s)</span><br><span class="line">        mb.SetBlock(r, mesh)</span><br><span class="line">        mesh = mb</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute the min and max over local blocks</span></span><br><span class="line">    mn = sys.float_info.max</span><br><span class="line">    mx = -mn</span><br><span class="line">    it = mesh.NewIterator()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> it.IsDoneWithTraversal():</span><br><span class="line">        do = it.GetCurrentDataObject()</span><br><span class="line"></span><br><span class="line">        atts = do.GetPointData() <span class="keyword">if</span> arrayCen == vtkDataObject.POINT \</span><br><span class="line">             <span class="keyword">else</span> do.GetCellData()</span><br><span class="line"></span><br><span class="line">        da = vtknp.vtk_to_numpy(atts.GetArray(arrayName))</span><br><span class="line"></span><br><span class="line">        mn = min(mn, np.min(da))</span><br><span class="line">        mx = max(mx, np.max(da))</span><br><span class="line"></span><br><span class="line">        it.GoToNextItem()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute global min and max</span></span><br><span class="line">    mn = comm.allreduce(mn, op=MPI.MIN)</span><br><span class="line">    mx = comm.allreduce(mx, op=MPI.MAX)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute the histogram over local blocks</span></span><br><span class="line">    it.InitTraversal()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> it.IsDoneWithTraversal():</span><br><span class="line">        do = it.GetCurrentDataObject()</span><br><span class="line"></span><br><span class="line">        atts = do.GetPointData() <span class="keyword">if</span> arrayCen == vtkDataObject.POINT \</span><br><span class="line">             <span class="keyword">else</span> do.GetCellData()</span><br><span class="line"></span><br><span class="line">        da = vtknp.vtk_to_numpy(atts.GetArray(arrayName))</span><br><span class="line"></span><br><span class="line">        h,be = np.histogram(da, bins=numBins, range=(mn,mx))</span><br><span class="line"></span><br><span class="line">        hist = hist + h <span class="keyword">if</span> <span class="string">'hist'</span> <span class="keyword">in</span> globals() <span class="keyword">else</span> h</span><br><span class="line"></span><br><span class="line">        it.GoToNextItem()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute the global histogram on rank 0</span></span><br><span class="line">    h = comm.reduce(hist, root=<span class="number">0</span>, op=MPI.SUM)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># rank 0 write to disk</span></span><br><span class="line">    <span class="keyword">if</span> r == <span class="number">0</span>:</span><br><span class="line">        ts = adaptor.GetDataTimeStep()</span><br><span class="line">        fn = <span class="string">'%s_%s_%d.txt'</span>%(outFile, arrayName, ts)</span><br><span class="line">        f = file(fn, <span class="string">'w'</span>)</span><br><span class="line">        f.write(<span class="string">'num bins : %d\n'</span>%(numBins))</span><br><span class="line">        f.write(<span class="string">'range : %0.6g %0.6g\n'</span>%(mn, mx))</span><br><span class="line">        f.write(<span class="string">'bin edges: '</span>)</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> be:</span><br><span class="line">            f.write(<span class="string">'%0.6g '</span>%(v))</span><br><span class="line">        f.write(<span class="string">'\n'</span>)</span><br><span class="line">        f.write(<span class="string">'counts : '</span>)</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> h:</span><br><span class="line">            f.write(<span class="string">'%d '</span>%(v))</span><br><span class="line">        f.write(<span class="string">'\n'</span>)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Finalize</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<h3 id="Histogram-xml" class="article-heading"><a href="#Histogram-xml" class="headerlink" title="Histogram.xml"></a>Histogram.xml<a class="article-anchor" href="#Histogram-xml" aria-hidden="true"></a></h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">analysis</span> <span class="attr">type</span>=<span class="string">"python"</span> <span class="attr">script_file</span>=<span class="string">"./Histogram.py"</span> <span class="attr">enabled</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">initialize_source</span>&gt;</span></span><br><span class="line">numBins=10</span><br><span class="line">meshName='mesh'</span><br><span class="line">arrayName='values'</span><br><span class="line">arrayCen=1</span><br><span class="line">     <span class="tag">&lt;/<span class="name">initialize_source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">analysis</span>&gt;</span></span><br></pre></td></tr></table></figure>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2018-11-11T16:04:39.832Z" itemprop="dateModified">Last updated: 2018-11-11</time>
                <a href="index.html" class="article-footer-prev" title="Overview"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="adios-schema.html" class="article-footer-next" title="Dataset schema"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PythonAnalysis-adaptor"><span class="toc-text">PythonAnalysis adaptor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigurableAnalysis-XML"><span class="toc-text">ConfigurableAnalysis XML</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-Template"><span class="toc-text">Code Template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example"><span class="toc-text">Example</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Histogram-py"><span class="toc-text">Histogram.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Histogram-xml"><span class="toc-text">Histogram.xml</span></a></li></ol></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner"><strong class="sidebar-title">Using</strong><a href="index.html" class="sidebar-link">Overview</a><a href="python-analysis.html" class="sidebar-link current">Python Analysis</a><a href="adios-schema.html" class="sidebar-link">Dataset schema</a><strong class="sidebar-title">Contributing</strong><a href="contribute.html" class="sidebar-link">Overview</a><a href="testing.html" class="sidebar-link">Testing</a></div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2018 <a href="https://www.kitware.com/" target="_blank">sensei</a>
    </div>
    <div id="footer-links">
      <a href="https://github.com/kitware/sensei" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/learn-more/" class="mobile-nav-link">Learn more</a><a href="/develop/" class="mobile-nav-link">Develop</a><a href="/news/" class="mobile-nav-link">News</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/kitware/sensei" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">Using</strong><a href="index.html" class="mobile-nav-link">Overview</a><a href="python-analysis.html" class="mobile-nav-link current">Python Analysis</a><a href="adios-schema.html" class="mobile-nav-link">Dataset schema</a><strong class="mobile-nav-title">Contributing</strong><a href="contribute.html" class="mobile-nav-link">Overview</a><a href="testing.html" class="mobile-nav-link">Testing</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- build:js build/js/main.js -->
<script src="/js/lang_select.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/mobile_nav.js"></script>
<!-- endbuild -->
<script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script>



</body>
</html>